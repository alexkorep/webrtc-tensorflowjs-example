<html>
  <head>
    <!-- Load TensorFlow.js -->
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@0.14.2"> </script>

    <script>
      tf.loadModel('jsmodel/model.json')
        .then(function (model) {
          console.log(model)
          const webrtcElement = document.getElementById("gum-local");
          window.requestAnimationFrame(onFrame.bind(null, model, webrtcElement));
        })

      function onFrame(model, webrtcElement) {
        const tensor = tf.fromPixels(webrtcElement);
        const eTensor = tensor.expandDims(0).asType('float32').div(256.0);
        const pred = model.predict(eTensor);
        max = tf.argMax(pred, 1)

        const predValues = pred.dataSync();
        const predArray = Array.from(predValues);
        meanScore = calcMeanScore(predArray)

        const index = max.get([0])
        const labelElement = document.getElementById("label");
        labelElement.innerHTML = index + ' | ' + meanScore
        window.requestAnimationFrame(onFrame.bind(null, model, webrtcElement));
      }

      function normalizeLabels(labels) {
        const arrSum = labels.reduce((a, b) => a + b, 0)
        return labels.map(a => a/arrSum)
        // labels_np = np.array(labels)
        // return labels_np / labels_np.sum()
      }


      function calcMeanScore(scoreDist) {
        // scoreDist = normalizeLabels(scoreDist)
        // //return (scoreDist*55).sum()
        // return scoreDist.reduce((a, b) => a + b, 0) * 55
        let result = 0
        for (let i = 1; i <= 10; i++) {
          result += i*scoreDist[i - 1]
        }
        return result
      }


      /////////////////
      // WEBRTC

      // Put variables in global scope to make them available to the browser console.
      const constraints = window.constraints = {
        audio: false,
        video: true
      };

      function handleSuccess(stream) {
        const video = document.querySelector('video');
        const videoTracks = stream.getVideoTracks();
        console.log('Got stream with constraints:', constraints);
        console.log(`Using video device: ${videoTracks[0].label}`);
        window.stream = stream; // make variable available to browser console
        video.srcObject = stream;
      }

      function handleError(error) {
        if (error.name === 'ConstraintNotSatisfiedError') {
          let v = constraints.video;
          errorMsg(`The resolution ${v.width.exact}x${v.height.exact} px is not supported by your device.`);
        } else if (error.name === 'PermissionDeniedError') {
          errorMsg('Permissions have not been granted to use your camera and ' +
            'microphone, you need to allow the page access to your devices in ' +
            'order for the demo to work.');
        }
        errorMsg(`getUserMedia error: ${error.name}`, error);
      }

      function errorMsg(msg, error) {
        const errorElement = document.querySelector('#errorMsg');
        errorElement.innerHTML += `<p>${msg}</p>`;
        if (typeof error !== 'undefined') {
          console.error(error);
        }
      }

      navigator.mediaDevices
        .getUserMedia(constraints)
        .then(handleSuccess)
        .catch(handleError);
    </script>
  </head>

  <body>
      <video id="gum-local" width="224" height="224" autoplay playsinline></video>
      <div id="label"></div>
      <div id="errorMsg"></div>
  </body>
</html>