<html>
  <head>
    <!-- Load TensorFlow.js -->
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@0.14.2"> </script>

    <script>
      tf.loadModel('jsmodel/model.json')
        .then(function (model) {
          console.log(model)
          const webrtcElement = document.getElementById("gum-local");

          const canvas = document.createElement('canvas');
          canvas.width = 224;
          canvas.height = 224;
          //document.body.appendChild(canvas)

          window.requestAnimationFrame(onFrame.bind(null, model, webrtcElement, canvas));
        })

      const VIDEO_WIDTH = 640
      const VIDEO_HEIGHT = 480
      const NET_SIZE = 224

      function onFrame(model, webrtcElement, canvas) {
        const ctx = canvas.getContext('2d');
        ctx.drawImage(webrtcElement, 0, 0, VIDEO_WIDTH, VIDEO_HEIGHT, 0, 0, NET_SIZE, NET_SIZE);

        //const tensor = tf.fromPixels(webrtcElement);
        const tensor = tf.fromPixels(canvas);
        const eTensor = tensor.expandDims(0).asType('float32').div(256.0);
        const pred = model.predict(eTensor);
        max = tf.argMax(pred, 1)

        const predValues = pred.dataSync();
        const predArray = Array.from(predValues);
        meanScore = calcMeanScore(predArray)

        const labelElement = document.getElementById("label");
        labelElement.innerHTML = meanScore.toFixed(2)
        window.requestAnimationFrame(onFrame.bind(null, model, webrtcElement, canvas));
      }

      function calcMeanScore(scoreDist) {
        let result = 0
        for (let i = 1; i <= 10; i++) {
          result += i*scoreDist[i - 1]
        }
        return result
      }


      /////////////////
      // WEBRTC

      function handleSuccess(stream) {
        const video = document.querySelector('video');
        const videoTracks = stream.getVideoTracks();
        console.log(`Using video device: ${videoTracks[0].label}`);
        window.stream = stream; // make variable available to browser console
        video.srcObject = stream;
      }

      function handleError(error) {
        if (error.name === 'ConstraintNotSatisfiedError') {
          errorMsg(`The resolution is not supported by your device.`);
        } else if (error.name === 'PermissionDeniedError') {
          errorMsg('Permissions have not been granted to use your camera and ' +
            'microphone, you need to allow the page access to your devices in ' +
            'order for the demo to work.');
        }
        errorMsg(`getUserMedia error: ${error.name}`, error);
      }

      function errorMsg(msg, error) {
        const errorElement = document.querySelector('#errorMsg');
        errorElement.innerHTML += `<p>${msg}</p>`;
        if (typeof error !== 'undefined') {
          console.error(error);
        }
      }

      function initCamera(front) {
        var constraints = {
          video: {
            facingMode: (front? "user" : "environment")
          },
          audio: false
        }

        navigator.mediaDevices
          .getUserMedia(constraints)
          .then(handleSuccess)
          .catch(handleError);
      }


      let front = false;
      initCamera(front)

    </script>
  </head>

  <body style='font-size: 64pt;'>
      <video id="gum-local" width="100%" height="100%" autoplay playsinline style='position: absolute;'></video>
      <div id="label" style='text-align: center;'>Loading network, please wait...</div>
      <div id="errorMsg"></div>
  </body>
  <script>
    document.getElementById('gum-local').onclick = () => {
      front = !front;
      initCamera(front)
    };
  </script>
</html>